<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TUG - The Unseen Generation</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<!-- Desktop Navigation (your existing nav) -->
<div class="navigation">
  <div class="hamburger" onclick="toggleMenu()">☰</div>
  <a href="index.html"><img src="images/logo.png" alt="Unseen Generation Logo" height="60px" width="50px" loading="lazy"/></a>
  <nav class="desktop-nav">
    <div class="dropdown">
      <a href="#">About</a>
      <div class="dropdown-content">
        <a href="main.html">the UNSEEN generation</a>
        <a href="born.html">How It Was Born</a>
        <a href="mission.html">Mission</a>
        <a href="vision.html">Vision</a>
      </div>
    </div>
    <a href="causes.html">Causes</a>
    <a href="ef.html">Empowerment Fridays</a>
    <a href="seen&heard.html">Seen & Heard</a>
    <a href="TUG.html">TUG</a>
    <a href="gallery.html">Gallery</a>
    <a href="contact.html">Contact</a>
  </nav>
</div>

<div class="container">
  <h1>The Unseen Generation (TUG)</h1>
  <p>Welcome to The Unseen Generation (TUG) Space
This is your safe corner to share your story—moments when you felt seen, heard, loved, or supported. Here, your voice matters, your experiences are valued, and your story can inspire others. Post freely, read, and connect with a community that understands that even the smallest acknowledgment can make a huge difference.

TUG is more than a page—it’s a movement. Your story counts. Your voice matters.</p>

  <!-- Auth UI -->
  <div id="authArea">
    <div id="signedOutArea">
      <input type="email" id="authEmail" placeholder="Email for sign-in / register" />
      <input type="password" id="authPassword" placeholder="Password" />
      <button id="registerBtn">Register</button>
      <button id="loginBtn">Sign In</button>
      <button id="googleBtn" style="display:none">Sign in with Google (optional)</button>
      <p style="font-size:0.9em;color:#555">If you want to edit/delete your posts later, register and sign in with the same email used when posting.</p>
    </div>

    <div id="signedInArea" style="display:none;">
      <span id="userInfo"></span>
      <button id="logoutBtn">Sign Out</button>
    </div>
  </div>

  <!-- Post Form -->
  <div class="post-form">
      <input type="text" id="name" placeholder="Your Name">
      <input type="email" id="email" placeholder="Your Email (preferred)">
      <textarea id="message" rows="4" placeholder="Write something..."></textarea>
      <button id="postBtn">Post</button>
  </div>

  <!-- Posts Feed -->
  <div id="postsFeed"></div>
</div>

<footer id="site-footer">
<p>&copy; 2025 The Unseen Generation. All rights reserved.</p>
</footer>

<!-- Firebase v12 (modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  // ---------- Firebase config (keep as-is) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD8P_Cpg8oiGKWuefw8MDAGIGxuNwazlIY",
    authDomain: "theunseengeneration-ef3a7.firebaseapp.com",
    databaseURL: "https://theunseengeneration-ef3a7-default-rtdb.firebaseio.com",
    projectId: "theunseengeneration-ef3a7",
    storageBucket: "theunseengeneration-ef3a7.firebasestorage.app",
    messagingSenderId: "19836098555",
    appId: "1:19836098555:web:98632364991cfe7678dd5e"
  };

  const ADMIN_EMAIL = "zaneleradebesbongile04@gmail.com"; // admin identity (server-side account must be created in Firebase console)

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // refs
  const postsRef = ref(db, 'posts');
  const reportsRef = ref(db, 'reports');

  // elements
  const postBtn = document.getElementById('postBtn');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const messageInput = document.getElementById('message');
  const feed = document.getElementById('postsFeed');

  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');
  const signedInArea = document.getElementById('signedInArea');
  const signedOutArea = document.getElementById('signedOutArea');
  const userInfo = document.getElementById('userInfo');

  // client state
  let currentUser = null;
  let currentPosts = {};

  // Save user email locally for convenience (optional)
  emailInput.addEventListener('blur', () => {
    localStorage.setItem('userEmail', emailInput.value.trim());
  });

  // Auth handlers
  registerBtn.addEventListener('click', async () => {
    const email = authEmail.value.trim();
    const pw = authPassword.value;
    if(!email || !pw) { alert("Enter email and password"); return; }
    try {
      await createUserWithEmailAndPassword(auth, email, pw);
      alert("Registered and signed in. Use same email when posting to later edit your posts.");
      authEmail.value = ""; authPassword.value = "";
    } catch(err) {
      console.error(err);
      alert("Register error: " + err.message);
    }
  });

  loginBtn.addEventListener('click', async () => {
    const email = authEmail.value.trim();
    const pw = authPassword.value;
    if(!email || !pw) { alert("Enter email and password"); return; }
    try {
      await signInWithEmailAndPassword(auth, email, pw);
      authEmail.value = ""; authPassword.value = "";
    } catch(err) {
      console.error(err);
      alert("Sign in error: " + err.message);
    }
  });

  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if(user){
      signedOutArea.style.display = "none";
      signedInArea.style.display = "block";
      userInfo.textContent = `${user.email} ${user.email === ADMIN_EMAIL ? "(Admin)" : ""}`;
    } else {
      signedOutArea.style.display = "block";
      signedInArea.style.display = "none";
      userInfo.textContent = "";
    }
    renderPosts(currentPosts);
  });

  // Posting (anyone can create)
  postBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const message = messageInput.value.trim();

    if(!name || !email || !message) {
      alert("Please fill in all fields.");
      return;
    }

    const newPostRef = push(postsRef);
    set(newPostRef, {
      id: newPostRef.key,
      name,
      email,
      message,
      time: new Date().toLocaleString()
    }).then(() => {
      nameInput.value = '';
      emailInput.value = '';
      messageInput.value = '';
      localStorage.setItem('userEmail', email); // convenience
    }).catch(err => {
      console.error("Post save error:", err);
      alert("Error saving post.");
    });
  });

  // Real-time listener
  onValue(postsRef, (snapshot) => {
    const posts = snapshot.val();
    currentPosts = posts || {};
    renderPosts(currentPosts);
  });

  // Render posts with auth-aware controls
  function renderPosts(posts) {
    feed.innerHTML = '';
    if(!posts) return;
    Object.values(posts).reverse().forEach(post => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.dataset.id = post.id;

      // determine permissions
      const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
      const isOwner = currentUser && currentUser.email === post.email;

      let menuHTML = '';
      if(isAdmin || isOwner){
        menuHTML = `
          <span class="menu" onclick="togglePostMenu('${post.id}')">⋮</span>
          <div id="menu-${post.id}" class="post-menu" style="display:none;">
            <div onclick="editPost('${post.id}')">Edit</div>
            <div onclick="deletePost('${post.id}')">Delete</div>
          </div>
        `;
      } else {
        // show report option to everyone
        menuHTML = `<span class="menu" onclick="reportPost('${post.id}')">⋮ Report</span>`;
      }

      postDiv.innerHTML = `
        <div class="post-header" style="position:relative;">
          <strong>${escapeHtml(post.name)}</strong>
          ${menuHTML}
        </div>
        <p>${escapeHtml(post.message)}</p>
        <small>${post.time}</small>
        <div class="reactions">
          <span onclick="react('${post.id}','Motivating 💪')">Motivating 💪</span>
          <span onclick="react('${post.id}','Inspiring ✨')">Inspiring ✨</span>
          <span onclick="react('${post.id}','Relatable 💭')">Relatable 💭</span>
          <span onclick="react('${post.id}','I See You 👀')">I See You 👀</span>
        </div>
      `;
      feed.appendChild(postDiv);
    });
  }

  // sanitize text to prevent simple XSS
  function escapeHtml(unsafe) {
    return (unsafe || '').replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#039;');
  }

  // Toggle post menu (global window to be callable from inline onclick)
  window.togglePostMenu = function(id){
    const menu = document.getElementById(`menu-${id}`);
    if(!menu) return;
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  };

  // Edit post (requires auth & either owner or admin)
  window.editPost = async function(id){
    if(!currentUser){
      alert("You must be signed in (same email as the post owner) to edit a post.");
      return;
    }
    const post = currentPosts[id];
    if(!post) { alert("Post not found."); return; }
    const isAdmin = currentUser.email === ADMIN_EMAIL;
    const isOwner = currentUser.email === post.email;
    if(!isAdmin && !isOwner){ alert("You don't have permission to edit this post."); return; }

    const newMessage = prompt("Edit your post:", post.message);
    if(newMessage === null) return; // cancelled
    if(newMessage.trim() === "") { alert("Message cannot be empty."); return; }

    const postRef = ref(db, `posts/${id}`);
    update(postRef, { message: newMessage.trim() }).catch(err => {
      console.error("Edit error:", err);
      alert("Edit failed.");
    });
  };

  // Delete post (requires auth & either owner or admin)
  window.deletePost = async function(id){
    if(!currentUser){
      alert("You must be signed in (same email as the post owner) to delete a post.");
      return;
    }
    const post = currentPosts[id];
    if(!post) { alert("Post not found."); return; }
    const isAdmin = currentUser.email === ADMIN_EMAIL;
    const isOwner = currentUser.email === post.email;
    if(!isAdmin && !isOwner){ alert("You don't have permission to delete this post."); return; }

    if(!confirm("Are you sure you want to delete this post?")) return;
    const postRef = ref(db, `posts/${id}`);
    remove(postRef).catch(err => {
      console.error("Delete error:", err);
      alert("Delete failed.");
    });
  };

  // Report post (anyone can report)
  window.reportPost = function(id){
    const reportRef = push(reportsRef);
    const reportData = { postId: id, time: new Date().toLocaleString() };
    set(reportRef, reportData)
      .then(() => {
        // optionally notify via Formspree (keeps your existing flow)
        fetch("https://formspree.io/f/mnnoqpyz", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ _subject: "TUG Post Reported!", postId: id, time: reportData.time })
        }).then(resp => {
          if(resp.ok) alert("Post reported. Admin will be notified via email.");
          else alert("Report saved, but email may have failed.");
        }).catch(err => {
          console.error("Email send error:", err);
          alert("Report saved, but email may have failed.");
        });
      }).catch(err => {
        console.error("Report save error:", err);
        alert("Could not save report.");
      });
  };

  // Reactions (client-only UX)
  window.react = function(id, reaction){
    alert(`You reacted: ${reaction}`);
  };

  // Close menus when clicking outside
  document.addEventListener('click', function(event){
    const postsMenus = document.querySelectorAll('.post-menu');
    postsMenus.forEach(menu=>{
      if(!menu.contains(event.target) && !event.target.classList.contains('menu')){
        menu.style.display = 'none';
      }
    });
  });

  // --- end of module ---
</script>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <a href="index.html">🏠 Home</a>
  <a href="about.html">About</a>
  <a href="causes.html">Causes</a>
  <a href="ef.html">Empowerment Fridays</a>
  <a href="seen&heard.html">Seen & Heard</a>
  <a href="TUG.html">TUG</a>
  <a href="gallery.html">Gallery</a>
  <a href="contact.html">Contact</a>
</div>

<script>
  function toggleMenu() {
    const menu = document.getElementById("sideMenu");
    menu.classList.toggle("active");
  }
</script>
</body>
</html>
